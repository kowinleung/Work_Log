<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Simulator Shift Log</title>
    <style>
        :root {
            --bg-color: #06103D;
            --text-color: #ffffff;
            --accent-color: #3b82f6;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --card-bg: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(255, 255, 255, 0.15);
            --dropdown-bg: #1e2550;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch; 
        }

        /* --- Layout & Navigation --- */
        .page {
            display: none;
            flex-direction: column;
            padding: 20px;
            height: 100%;
            box-sizing: border-box;
            animation: fadeIn 0.3s ease-in-out;
            overflow-y: auto;
        }

        .page.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Welcome Page --- */
        #welcome-page {
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .logo-container {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }

        .logo-placeholder {
            font-size: 80px;
            background: rgba(255,255,255,0.1);
            width: 140px;
            height: 140px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
            border: 2px solid rgba(255,255,255,0.1);
        }

        h1 {
            font-weight: 300;
            margin-bottom: 50px;
            letter-spacing: 1px;
            font-size: 1.5rem;
        }

        /* --- Forms & Inputs --- */
        .form-group {
            margin-bottom: 25px;
            width: 100%;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #8da4ef;
            font-weight: 600;
        }

        .date-input-wrapper {
            position: relative;
            background: var(--input-bg);
            border-radius: 16px;
            display: flex;
            align-items: center;
            padding: 5px 15px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        input[type="date"], input[type="text"], select, textarea, input[type="search"] {
            width: 100%;
            padding: 16px;
            background-color: var(--input-bg);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-family: inherit;
            outline: none;
            margin-bottom: 10px;
            appearance: none;
            -webkit-appearance: none;
            box-sizing: border-box;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            line-height: 1.5;
        }

        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
            padding-right: 40px;
        }

        select option {
            background-color: var(--dropdown-bg);
            color: white;
            padding: 10px;
        }

        input[type="date"] {
            background: transparent;
            border: none;
            margin-bottom: 0;
            padding: 15px 0;
        }

        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* --- Shift Selector (Tiles) --- */
        .shift-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }

        .shift-card {
            background: var(--input-bg);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .shift-card.selected {
            background: var(--accent-color);
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }

        .shift-card .title { font-size: 12px; font-weight: bold; display: block; margin-top: 5px;}
        .shift-card .icon { font-size: 24px; }
        .shift-card .time { font-size: 10px; opacity: 0.7; display: block; }

        /* --- Activity Logger Styles --- */
        .activity-builder {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 16px;
            border: 1px dashed rgba(255,255,255,0.1);
        }

        .dynamic-field {
            display: none;
            margin-top: 15px;
            animation: fadeIn 0.3s;
        }

        .activity-list {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .activity-item {
            background: var(--card-bg);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            border-left: 3px solid var(--accent-color);
        }
        
        .activity-text {
            flex-grow: 1;
            white-space: pre-wrap;
            margin-right: 10px;
        }

        .activity-thumb {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
            margin-right: 10px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .activity-controls {
            display: flex;
            gap: 5px;
        }

        .activity-controls button {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .activity-controls button.delete-btn {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        /* --- Buttons --- */
        .btn {
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            text-align: center;
            transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.8; }

        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-secondary { background-color: transparent; border: 2px solid rgba(255,255,255,0.3); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-add { background-color: var(--success-color); color: white; margin-top: 10px; }
        .btn-update { background-color: var(--accent-color); color: white; margin-top: 10px; }

        /* File Inputs (Hidden) */
        #import-file, #act-photo-input { display: none; }

        /* --- Photo Upload UI --- */
        .photo-upload-area {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .photo-btn {
            background: transparent;
            border: 1px dashed #8da4ef;
            color: #8da4ef;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .photo-preview-container {
            position: relative;
            width: 60px;
            height: 60px;
            display: none;
        }
        
        .photo-preview-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .remove-photo-btn {
            position: absolute;
            top: -5px; right: -5px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- Records List & Filters --- */
        .record-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .record-header { display: flex; justify-content: space-between; color: var(--accent-color); font-weight: bold; margin-bottom: 5px; }
        
        .record-content { 
            white-space: pre-wrap; 
            font-size: 0.9em; 
            line-height: 1.5; 
            color: #ddd; 
        }
        
        .log-title {
            color: #fff;
            font-weight: 700;
            font-size: 1.1em;
            display: inline-block;
            margin-top: 8px;
            margin-bottom: 2px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.3);
        }

        .record-img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
            margin-top: 5px;
            display: block;
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
        }

        .record-actions { margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px; }
        .btn-sm { padding: 5px 12px; font-size: 12px; width: auto; border-radius: 6px; }

        .data-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .filter-section {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .filter-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .filter-row select { 
            width: 50%;
        }

        .sort-bar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
            padding: 0 5px;
        }

        .sort-btn {
            background: none;
            border: none;
            color: #8da4ef;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sort-btn:active { opacity: 0.7; }

        /* --- Modal --- */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #1a224a;
            padding: 25px;
            border-radius: 16px;
            width: 85%;
            max-width: 320px;
            text-align: center;
        }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }

        .page-header { display: flex; align-items: center; margin-bottom: 20px; }
        .back-btn { background: none; border: none; color: white; font-size: 24px; margin-right: 15px; padding: 0; cursor: pointer; }

        /* Image Viewer Modal */
        #img-modal .modal-content {
            background: transparent;
            padding: 0;
            width: 100%;
            height: 100%;
            max-width: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #img-modal img {
            max-width: 95%;
            max-height: 80%;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #img-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            font-size: 30px;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

    <!-- 1. Welcome Page -->
    <div id="welcome-page" class="page active">
        <div class="logo-container">
            <!-- Safe Public Placeholder Logo -->
            <div class="logo-placeholder">‚úàÔ∏è</div>
        </div>
        <h1>Work Logging System</h1>
        
        <button class="btn btn-primary" onclick="onStartShift()">Start Shift</button>
        <button id="continue-btn" class="btn btn-secondary" style="display:none" onclick="continueShift()">Continue Shift</button>
        <button class="btn btn-secondary" onclick="showPage('records-page')">Shift Record</button>
    </div>

    <!-- 2. Logging Page -->
    <div id="shift-page" class="page">
        <div class="page-header">
            <button class="back-btn" onclick="history.back()">‚Üê</button>
            <h2>Log Entry</h2>
        </div>

        <div class="form-group">
            <label>Date</label>
            <div class="date-input-wrapper">
                <input type="date" id="shift-date">
            </div>
        </div>

        <div class="form-group">
            <label>Shift Session</label>
            <input type="hidden" id="shift-type" value="Regular 0830-1730">
            <div class="shift-grid">
                <div class="shift-card selected" data-value="Regular 0830-1730" onclick="selectShiftCard(this, 'Regular 0830-1730')">
                    <span class="icon">üè¢</span><span class="title">Regular</span><span class="time">0830-1730</span>
                </div>
                <div class="shift-card" data-value="Day 0800-2000" onclick="selectShiftCard(this, 'Day 0800-2000')">
                    <span class="icon">‚òÄÔ∏è</span><span class="title">Day</span><span class="time">0800-2000</span>
                </div>
                <div class="shift-card" data-value="Night 2000-0800" onclick="selectShiftCard(this, 'Night 2000-0800')">
                    <span class="icon">üåô</span><span class="title">Night</span><span class="time">2000-0800</span>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Activity Log</label>
            
            <div class="activity-builder">
                <input type="hidden" id="edit-activity-index" value="-1">
                <input type="hidden" id="act-photo-data" value="">
                
                <select id="act-type" onchange="updateFormFields()">
                    <option value="">-- Select Activity Type --</option>
                    <option value="Morning Briefing">Morning Briefing</option>
                    <option value="Session Change">Session Change</option>
                    <option value="Preflight Checks">Preflight Checks</option>
                    <option value="Walk-Around Check">Walk-Around Check</option>
                    <option value="Preventive Maintenance">Preventive Maintenance</option>
                    <option value="Other">Other</option>
                </select>

                <div id="field-simulator" class="dynamic-field">
                    <select id="act-sim" onchange="updateConfigs()">
                        <option value="">-- Select Device --</option>
                    </select>
                </div>

                <div id="field-pm-item" class="dynamic-field">
                    <select id="act-pm-item">
                        <option value="">-- Select PM Item --</option>
                        <option value="Sim 4">Sim 4</option>
                        <option value="Sim 7">Sim 7</option>
                        <option value="A330">A330</option>
                        <option value="IPT/FDT">IPT/FDT</option>
                        <option value="SEPs">SEPs</option>
                    </select>
                </div>

                <div id="field-config-from" class="dynamic-field">
                    <label style="font-size: 0.7em; margin-bottom: 5px;">From Config</label>
                    <select id="act-config-from"></select>
                </div>

                <div id="field-config-to" class="dynamic-field">
                    <label style="font-size: 0.7em; margin-bottom: 5px;">To Config</label>
                    <select id="act-config-to"></select>
                </div>

                <div id="field-config-single" class="dynamic-field">
                    <label style="font-size: 0.7em; margin-bottom: 5px;">Configuration</label>
                    <select id="act-config-single"></select>
                </div>

                <div id="field-floor" class="dynamic-field">
                    <select id="act-floor">
                        <option value="">-- Select Floor --</option>
                        <option value="5th Floor">5th Floor</option>
                        <option value="9th Floor">9th Floor</option>
                    </select>
                </div>

                <div id="field-desc" class="dynamic-field" style="display:block">
                    <textarea id="act-desc" placeholder="Description / Notes..."></textarea>
                </div>

                <!-- Photo Upload UI -->
                <div class="photo-upload-area">
                    <button class="photo-btn" onclick="document.getElementById('act-photo-input').click()">üì∑ Attach Photo</button>
                    <input type="file" id="act-photo-input" accept="image/*" onchange="handlePhotoUpload(this)">
                    
                    <div id="photo-preview-box" class="photo-preview-container">
                        <img id="photo-preview-img" src="" alt="Preview" onclick="showImgModal(this.src)">
                        <button class="remove-photo-btn" onclick="removePhoto()">√ó</button>
                    </div>
                </div>

                <button id="add-btn" class="btn btn-add" onclick="handleActivityAction()">+ Add Entry</button>
                <button id="cancel-edit-btn" class="btn btn-secondary" style="display:none; margin-top:5px; padding:10px;" onclick="cancelEditActivity()">Cancel Edit</button>
            </div>

            <div id="activity-list" class="activity-list"></div>
            <input type="hidden" id="shift-log-hidden">
        </div>

        <input type="hidden" id="edit-id">

        <div class="form-group" style="margin-top: 30px;">
            <button class="btn btn-secondary" onclick="saveDraftShift()">Save & Return</button>
            <button class="btn btn-danger" onclick="confirmEndShift()">End Shift & Save</button>
        </div>
    </div>

    <!-- 3. Records Page -->
    <div id="records-page" class="page">
        <div class="page-header">
            <button class="back-btn" onclick="history.back()">‚Üê</button>
            <h2>Shift Records</h2>
        </div>

        <div class="data-controls">
            <button class="btn btn-secondary" onclick="exportData()" style="font-size: 14px; padding: 10px;">üì§ Export</button>
            <button class="btn btn-secondary" onclick="triggerImport()" style="font-size: 14px; padding: 10px;">üì• Import</button>
            <input type="file" id="import-file" accept=".json" onchange="importData(this)">
        </div>

        <div class="filter-section">
            <input type="search" id="search-input" placeholder="üîç Search records..." onkeyup="renderRecords()">
            
            <div class="filter-row">
                <select id="filter-year" onchange="renderRecords()">
                    <option value="">All Years</option>
                </select>
                <select id="filter-month" onchange="renderRecords()">
                    <option value="">All Months</option>
                    <option value="01">January</option>
                    <option value="02">February</option>
                    <option value="03">March</option>
                    <option value="04">April</option>
                    <option value="05">May</option>
                    <option value="06">June</option>
                    <option value="07">July</option>
                    <option value="08">August</option>
                    <option value="09">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>
        </div>

        <div class="sort-bar">
            <button id="sort-toggle-btn" class="sort-btn" onclick="toggleSortOrder()">
                Sort by Date <span id="sort-icon">‚Üì</span>
            </button>
            <input type="hidden" id="sort-order-val" value="desc">
        </div>

        <div id="records-list"></div>
    </div>

    <!-- --- Modals --- -->
    
    <!-- Image Modal -->
    <div id="img-modal" class="modal" onclick="closeImgModal()">
        <div class="modal-content">
            <button id="img-modal-close" onclick="closeImgModal()">√ó</button>
            <img id="img-modal-target" src="" onclick="event.stopPropagation()">
        </div>
    </div>

    <div id="alert-modal" class="modal">
        <div class="modal-content">
            <h3 id="alert-title">Notice</h3>
            <p id="alert-msg">Message goes here</p>
            <div class="modal-buttons" style="justify-content: center;">
                <button class="btn btn-primary" onclick="closeAlertModal()">OK</button>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <h3>Delete Record?</h3>
            <p>This action cannot be undone.</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDeleteAction()">Delete</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h3>End Shift?</h3>
            <p>Are you sure you want to save this log?</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveShift()">Confirm</button>
            </div>
        </div>
    </div>

    <div id="start-modal" class="modal">
        <div class="modal-content">
            <h3>Shift in Progress</h3>
            <p>You have a started shift. End it and start new?</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeStartModal()">No, Keep</button>
                <button class="btn btn-primary" onclick="confirmEndAndStartNew()">Yes, New</button>
            </div>
        </div>
    </div>

    <div id="empty-draft-modal" class="modal">
        <div class="modal-content">
            <h3>Empty Shift Found</h3>
            <p>Current shift is empty. Delete it and start new, or continue current?</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="continueFromModal()">Continue</button>
                <button class="btn btn-danger" onclick="discardAndStartNew()">Delete & New</button>
            </div>
        </div>
    </div>

    <script>
        // --- Data Definitions ---
        const CONFIGS = {
            "Sim 4": ["CAE_IAE", "CAE_CFM", "AMU_IAE", "HKA_CFM", "HKE_IAE"],
            "Sim 7": [
                "CAE_IAE", "CAE_CFM", "CAE_NEO_LEAP", "CAE_NEO_PW", "HKA_CFM",
                "HKE_IAE_TCAS_ON_RNP (HKE Default)", "HKE_IAE_TCAS_ON_FLS", 
                "HKE_IAE_TCAS_OFF_RNP", "HKE_IAE_TCAS_OFF_FLS", "HKE_NEO_PW"
            ],
            "A330": [
                "HKA_RR_BUSS_ON_AP/FD_TCAS_OFF (HKA Default)", "HKA_RR_BUSS_ON_AP/FD_TCAS_ON",
                "HKA_RR_BUSS_OFF_AP/FD_TCAS_OFF", "HKA_RR_BUSS_OFF_AP/FD_TCAS_ON",
                "HKC_RR", "AHK_RR"
            ],
            "HKA IPT": ["HKA_CFM", "HKA_NEO_PW"],
            "HKA FTD": ["HKA_RR"],
            "CAE IPT": ["IAE_Metric", "IAE_Imperial", "CFM_Metric", "CFM_Imperial"]
        };

        const PFC_OPTIONS = ["Sim 4", "Sim 7", "A330", "HKA IPT", "HKA FTD", "CAE IPT"];
        const SESSION_CHANGE_OPTIONS = ["Sim 4", "Sim 7", "A330", "HKA IPT", "HKA FTD", "CAE IPT"];

        let currentActivities = [];
        let recordToDeleteId = null; 
        let currentPageId = 'welcome-page'; 
        
        let isEditingMode = false;

        const CURRENT_SHIFT_KEY = 'cae_current_shift';
        const CURRENT_ACTIVITIES_KEY = 'cae_current_acts_obj';

        document.addEventListener('DOMContentLoaded', () => {
            updateContinueButton();
            updateMorningBriefingVisibility();
            
            history.replaceState({page: 'welcome-page'}, '', '');
            
            window.onpopstate = function(event) {
                if(event.state && event.state.page) {
                    showPage(event.state.page, false);
                } else {
                    showPage('welcome-page', false);
                }
            };
        });

        // --- NAVIGATION LOGIC ---
        function showPage(pageId, addHistory = true) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            currentPageId = pageId;

            if(pageId === 'records-page') {
                populateYearFilter();
                renderRecords();
            }

            if (addHistory) {
                history.pushState({page: pageId}, '', '');
            }
        }

        // --- Custom Alert Logic ---
        function showAlert(msg, title = "Notice") {
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-msg').innerText = msg;
            document.getElementById('alert-modal').style.display = 'flex';
        }

        function closeAlertModal() {
            document.getElementById('alert-modal').style.display = 'none';
        }

        // --- Select & Form Logic ---
        function selectShiftCard(element, value) {
            document.getElementById('shift-type').value = value;
            document.querySelectorAll('.shift-card').forEach(c => c.classList.remove('selected'));
            element.classList.add('selected');
            updateMorningBriefingVisibility();
        }

        function updateMorningBriefingVisibility() {
            const shiftType = document.getElementById('shift-type').value;
            const typeSelect = document.getElementById('act-type');
            const briefingOption = typeSelect.querySelector('option[value="Morning Briefing"]');
            
            if (shiftType.includes("Regular") || shiftType.includes("Day")) {
                if(briefingOption) briefingOption.disabled = false;
            } else {
                if(briefingOption) briefingOption.disabled = true;
                if(typeSelect.value === "Morning Briefing") typeSelect.value = "";
            }
        }

        function updateFormFields() {
            const type = document.getElementById('act-type').value;
            document.querySelectorAll('.dynamic-field').forEach(el => {
                if(el.id !== 'field-desc') el.style.display = 'none';
            });
            
            if (type === "Session Change") {
                setupSimulatorDropdown(SESSION_CHANGE_OPTIONS);
                document.getElementById('field-simulator').style.display = 'block';
                document.getElementById('field-config-from').style.display = 'block';
                document.getElementById('field-config-to').style.display = 'block';
            } 
            else if (type === "Preflight Checks") {
                setupSimulatorDropdown(PFC_OPTIONS);
                document.getElementById('field-simulator').style.display = 'block';
                document.getElementById('field-config-single').style.display = 'block';
            }
            else if (type === "Walk-Around Check") {
                document.getElementById('field-floor').style.display = 'block';
            }
            else if (type === "Preventive Maintenance") {
                document.getElementById('field-pm-item').style.display = 'block';
            }
        }

        function setupSimulatorDropdown(options) {
            const select = document.getElementById('act-sim');
            const currentVal = select.value;
            select.innerHTML = '<option value="">-- Select Device --</option>';
            options.forEach(opt => {
                const el = document.createElement('option');
                el.value = opt;
                el.innerText = opt;
                select.appendChild(el);
            });
            select.value = currentVal;
        }

        function updateConfigs() {
            const sim = document.getElementById('act-sim').value;
            const type = document.getElementById('act-type').value;
            const refreshSelect = (id, opts) => {
                const el = document.getElementById(id);
                const oldVal = el.value;
                el.innerHTML = '<option value="">-- Config --</option>';
                opts.forEach(opt => {
                    const optEl = document.createElement('option');
                    optEl.value = opt;
                    optEl.innerText = opt;
                    el.appendChild(optEl);
                });
                if (opts.includes(oldVal)) el.value = oldVal;
            };

            if (sim && CONFIGS[sim]) {
                if (type === "Session Change") {
                    refreshSelect('act-config-from', CONFIGS[sim]);
                    refreshSelect('act-config-to', CONFIGS[sim]);
                } else if (type === "Preflight Checks") {
                    refreshSelect('act-config-single', CONFIGS[sim]);
                }
            } else {
                document.getElementById('act-config-from').innerHTML = '';
                document.getElementById('act-config-to').innerHTML = '';
                document.getElementById('act-config-single').innerHTML = '';
            }
        }

        // --- PHOTO HANDLING ---
        function handlePhotoUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Compress image using Canvas
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const maxWidth = 800; // Constrain width

                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Compress to JPEG 0.7 quality
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    
                    document.getElementById('act-photo-data').value = dataUrl;
                    document.getElementById('photo-preview-img').src = dataUrl;
                    document.getElementById('photo-preview-box').style.display = 'block';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function removePhoto() {
            document.getElementById('act-photo-data').value = "";
            document.getElementById('photo-preview-box').style.display = 'none';
            document.getElementById('act-photo-input').value = "";
        }

        function handleActivityAction() {
            const index = parseInt(document.getElementById('edit-activity-index').value);
            if (index === -1) addActivity();
            else updateActivity(index);
        }

        function getFormData() {
            const type = document.getElementById('act-type').value;
            if(!type) { showAlert("Please select an activity type."); return null; }

            const data = {
                type: type,
                sim: document.getElementById('act-sim').value,
                from: document.getElementById('act-config-from').value,
                to: document.getElementById('act-config-to').value,
                config: document.getElementById('act-config-single').value,
                floor: document.getElementById('act-floor').value,
                pm_item: document.getElementById('act-pm-item').value,
                desc: document.getElementById('act-desc').value,
                photo: document.getElementById('act-photo-data').value
            };

            if (type === "Session Change") {
                if (!data.sim || !data.from || !data.to) { showAlert("Please complete session details."); return null; }
            } else if (type === "Preflight Checks") {
                if (!data.sim || !data.config) { showAlert("Select device and config."); return null; }
            } else if (type === "Walk-Around Check") {
                if (!data.floor) { showAlert("Select floor."); return null; }
            } 
            else if (type === "Preventive Maintenance") {
                if (!data.pm_item) { showAlert("Select PM Item."); return null; }
            }
            return data;
        }

        function formatActivityString(data) {
            let s = `‚Ä¢ ${data.type}`;
            if (data.type === "Session Change") {
                s += `: ${data.sim} (${data.from} ‚ûù ${data.to})`;
            } else if (data.type === "Preflight Checks") {
                s += `: ${data.sim} (${data.config})`;
            } else if (data.type === "Walk-Around Check") {
                s += `: ${data.floor}`;
            } else if (data.type === "Preventive Maintenance") {
                s += `: ${data.pm_item}`;
            }
            if (data.desc) s += `\n  - Note: ${data.desc}`;
            return s;
        }

        function addActivity() {
            const data = getFormData();
            if(!data) return;
            currentActivities.push(data);
            resetForm();
            renderActivityList();
        }

        function updateActivity(index) {
            const data = getFormData();
            if(!data) return;
            currentActivities[index] = data;
            resetForm();
            renderActivityList();
        }

        function editActivity(index) {
            const data = currentActivities[index];
            if(!data) return;
            document.getElementById('act-type').value = data.type;
            updateFormFields();
            document.getElementById('act-floor').value = data.floor || "";
            document.getElementById('act-desc').value = data.desc || "";
            document.getElementById('act-pm-item').value = data.pm_item || "";

            if (data.sim) {
                document.getElementById('act-sim').value = data.sim;
                updateConfigs();
                if(data.from) document.getElementById('act-config-from').value = data.from;
                if(data.to) document.getElementById('act-config-to').value = data.to;
                if(data.config) document.getElementById('act-config-single').value = data.config;
            }

            // Load photo
            if (data.photo) {
                document.getElementById('act-photo-data').value = data.photo;
                document.getElementById('photo-preview-img').src = data.photo;
                document.getElementById('photo-preview-box').style.display = 'block';
            } else {
                removePhoto();
            }

            document.getElementById('edit-activity-index').value = index;
            const btn = document.getElementById('add-btn');
            btn.innerText = "Update Entry";
            btn.classList.remove('btn-add');
            btn.classList.add('btn-update');
            document.getElementById('cancel-edit-btn').style.display = 'block';
            document.querySelector('.activity-builder').scrollIntoView({behavior: 'smooth'});
        }

        function cancelEditActivity() { resetForm(); }

        function resetForm() {
            document.getElementById('act-type').value = "";
            document.getElementById('act-sim').value = "";
            document.getElementById('act-config-from').innerHTML = "";
            document.getElementById('act-config-to').innerHTML = "";
            document.getElementById('act-config-single').innerHTML = "";
            document.getElementById('act-floor').value = "";
            document.getElementById('act-pm-item').value = "";
            document.getElementById('act-desc').value = "";
            
            removePhoto();

            updateFormFields();
            document.getElementById('edit-activity-index').value = -1;
            const btn = document.getElementById('add-btn');
            btn.innerText = "+ Add Entry";
            btn.classList.remove('btn-update');
            btn.classList.add('btn-add');
            document.getElementById('cancel-edit-btn').style.display = 'none';
        }

        function renderActivityList() {
            const list = document.getElementById('activity-list');
            list.innerHTML = '';
            currentActivities.forEach((act, index) => {
                const text = formatActivityString(act);
                const div = document.createElement('div');
                div.className = 'activity-item';
                
                let imgHtml = '';
                if(act.photo) {
                    imgHtml = `<img src="${act.photo}" class="activity-thumb" onclick="showImgModal('${act.photo}')">`;
                }

                div.innerHTML = `
                    ${imgHtml}
                    <div class="activity-text">${text}</div>
                    <div class="activity-controls">
                        <button onclick="editActivity(${index})">‚úé</button>
                        <button class="delete-btn" onclick="removeActivity(${index})">√ó</button>
                    </div>
                `;
                list.appendChild(div);
            });
            const fullLogString = currentActivities.map(formatActivityString).join('\n\n');
            document.getElementById('shift-log-hidden').value = fullLogString;
        }

        function removeActivity(index) {
            if (parseInt(document.getElementById('edit-activity-index').value) === index) {
                cancelEditActivity();
            }
            currentActivities.splice(index, 1);
            renderActivityList();
        }

        // --- Shift Logic ---
        function onStartShift() {
            const current = getCurrentShift();
            if(!current) {
                startShift();
                return;
            }
            const savedActs = localStorage.getItem(CURRENT_ACTIVITIES_KEY);
            const acts = savedActs ? JSON.parse(savedActs) : [];

            if (acts.length === 0) {
                document.getElementById('empty-draft-modal').style.display = 'flex';
            } else {
                document.getElementById('start-modal').style.display = 'flex';
            }
        }

        function startShift() {
            isEditingMode = false;
            document.getElementById('edit-id').value = Date.now();
            currentActivities = [];
            renderActivityList();
            
            const defaultType = 'Regular 0830-1730';
            document.getElementById('shift-type').value = defaultType;
            document.querySelectorAll('.shift-card').forEach(c => c.classList.remove('selected'));
            document.querySelector('.shift-card[data-value="Regular 0830-1730"]').classList.add('selected');
            document.getElementById('shift-date').value = new Date().toISOString().split('T')[0];
            localStorage.removeItem(CURRENT_ACTIVITIES_KEY);

            setCurrentShift({
                id: Number(document.getElementById('edit-id').value),
                date: document.getElementById('shift-date').value,
                type: defaultType,
                log: ''
            });
            showPage('shift-page');
            updateMorningBriefingVisibility();
        }

        function continueShift() {
            isEditingMode = false;
            const current = getCurrentShift();
            if(!current) return;
            document.getElementById('edit-id').value = current.id;
            document.getElementById('shift-date').value = current.date;
            document.getElementById('shift-type').value = current.type;
            const savedActs = localStorage.getItem(CURRENT_ACTIVITIES_KEY);
            if (savedActs) {
                currentActivities = JSON.parse(savedActs);
            } else if (current.log) {
                currentActivities = current.log.split('\n\n').filter(x => x.trim()).map(txt => ({
                    type: "Legacy Entry", desc: txt 
                }));
            } else {
                currentActivities = [];
            }
            renderActivityList();
            const card = document.querySelector(`.shift-card[data-value="${current.type}"]`);
            if(card) selectShiftCard(card, current.type);
            showPage('shift-page');
        }

        function continueFromModal() {
            document.getElementById('empty-draft-modal').style.display = 'none';
            continueShift();
        }

        function discardAndStartNew() {
            document.getElementById('empty-draft-modal').style.display = 'none';
            localStorage.removeItem(CURRENT_SHIFT_KEY);
            localStorage.removeItem(CURRENT_ACTIVITIES_KEY);
            startShift();
        }

        function saveDraftShift() {
            const draft = {
                id: Number(document.getElementById('edit-id').value),
                date: document.getElementById('shift-date').value,
                type: document.getElementById('shift-type').value,
                log: document.getElementById('shift-log-hidden').value
            };
            localStorage.setItem(CURRENT_ACTIVITIES_KEY, JSON.stringify(currentActivities));
            setCurrentShift(draft);
            history.back(); // Return to previous page
        }

        function validateShift() {
            const date = document.getElementById('shift-date').value;
            if(!date) { 
                showAlert("Date required"); 
                return false; 
            }
            if(currentActivities.length === 0) { 
                showAlert("Please add at least one activity."); 
                return false; 
            }
            return true;
        }

        function confirmEndShift() {
            if(validateShift()) {
                document.getElementById('confirm-modal').style.display = 'flex'; 
            }
        }
        
        function closeModal() { document.getElementById('confirm-modal').style.display = 'none'; }
        function closeStartModal() { document.getElementById('start-modal').style.display = 'none'; }

        function saveShift() {
            const date = document.getElementById('shift-date').value;
            const log = document.getElementById('shift-log-hidden').value;

            let records = JSON.parse(localStorage.getItem('cae_logs') || '[]');
            const id = Number(document.getElementById('edit-id').value);
            const entry = {
                id: id,
                date: date,
                type: document.getElementById('shift-type').value,
                log: log,
                activities: currentActivities 
            };
            const idx = records.findIndex(r => r.id == id);
            if(idx !== -1) records[idx] = entry;
            else records.unshift(entry);
            
            try {
                localStorage.setItem('cae_logs', JSON.stringify(records));
            } catch (e) {
                showAlert("Storage Full! Cannot save images. Please delete old records.");
                return;
            }

            setCurrentShift(null);
            localStorage.removeItem(CURRENT_ACTIVITIES_KEY);
            closeModal();
            
            if (isEditingMode) {
                history.back();
            } else {
                history.replaceState({page: 'welcome-page'}, '', '');
                showPage('welcome-page', false);
            }
        }

        function confirmEndAndStartNew() {
            const current = getCurrentShift();
            if(current) {
                let records = JSON.parse(localStorage.getItem('cae_logs') || '[]');
                const idx = records.findIndex(r => r.id == current.id);
                const richActs = JSON.parse(localStorage.getItem(CURRENT_ACTIVITIES_KEY) || "[]");
                if(richActs.length > 0) {
                     current.log = richActs.map(formatActivityString).join('\n\n');
                     current.activities = richActs;
                }
                if(idx !== -1) records[idx] = current;
                else records.unshift(current);
                localStorage.setItem('cae_logs', JSON.stringify(records));
            }
            setCurrentShift(null);
            localStorage.removeItem(CURRENT_ACTIVITIES_KEY);
            closeStartModal();
            startShift();
        }

        function getCurrentShift() {
            const raw = localStorage.getItem(CURRENT_SHIFT_KEY);
            return raw ? JSON.parse(raw) : null;
        }
        function setCurrentShift(s) {
            if(s) localStorage.setItem(CURRENT_SHIFT_KEY, JSON.stringify(s));
            else localStorage.removeItem(CURRENT_SHIFT_KEY);
            updateContinueButton();
        }
        function updateContinueButton() {
            const btn = document.getElementById('continue-btn');
            const cur = getCurrentShift();
            if(btn) btn.style.display = cur ? 'block' : 'none';
        }

        // --- Records Logic ---
        function populateYearFilter() {
            const records = JSON.parse(localStorage.getItem('cae_logs') || '[]');
            const yearSelect = document.getElementById('filter-year');
            const currentVal = yearSelect.value; 
            
            const years = new Set(records.map(r => r.date.substring(0, 4)));
            const sortedYears = Array.from(years).sort().reverse();

            yearSelect.innerHTML = '<option value="">All Years</option>';
            sortedYears.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.innerText = y;
                yearSelect.appendChild(opt);
            });
            yearSelect.value = currentVal;
        }

        function toggleSortOrder() {
            const hiddenInput = document.getElementById('sort-order-val');
            const iconSpan = document.getElementById('sort-icon');
            
            if(hiddenInput.value === 'desc') {
                hiddenInput.value = 'asc';
                iconSpan.innerText = '‚Üë';
            } else {
                hiddenInput.value = 'desc';
                iconSpan.innerText = '‚Üì';
            }
            renderRecords();
        }

        function renderRecords() {
            const list = document.getElementById('records-list');
            const records = JSON.parse(localStorage.getItem('cae_logs') || '[]');
            
            const searchVal = document.getElementById('search-input').value.toLowerCase();
            const yearVal = document.getElementById('filter-year').value;
            const monthVal = document.getElementById('filter-month').value;
            const sortOrder = document.getElementById('sort-order-val').value;

            list.innerHTML = '';
            
            if(records.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:#888;">No records found.</p>';
                return;
            }

            const filtered = records.filter(r => {
                if (yearVal && !r.date.startsWith(yearVal)) return false;
                if (monthVal && r.date.substring(5, 7) !== monthVal) return false;
                if (searchVal) {
                    const content = (r.date + r.type + r.log).toLowerCase();
                    if (!content.includes(searchVal)) return false;
                }
                return true;
            });

            filtered.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });

            if(filtered.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:#888;">No matching records.</p>';
                return;
            }

            filtered.forEach(r => {
                const d = document.createElement('div');
                d.className = 'record-card';
                
                // Build HTML from structured activities if available
                let contentHtml = '';
                if (r.activities && r.activities.length > 0) {
                    contentHtml = r.activities.map(act => {
                        let line = formatActivityString(act);
                        // Bold title
                        line = line.replace(/^‚Ä¢\s*(.*?)(:|$)/m, '<span class="log-title">‚Ä¢ $1</span>$2');
                        // Image
                        let imgHtml = '';
                        if(act.photo) {
                            imgHtml = `<img src="${act.photo}" class="record-img" onclick="showImgModal('${act.photo}')">`;
                        }
                        return `<div>${line}${imgHtml}</div>`;
                    }).join('<br>');
                } else {
                    // Fallback for legacy string-only logs
                    let processedLog = r.log;
                    processedLog = processedLog.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    processedLog = processedLog.replace(/^‚Ä¢\s*(.*?)(:|$)/gm, '<span class="log-title">‚Ä¢ $1</span>$2');
                    contentHtml = processedLog;
                }

                d.innerHTML = `
                    <div class="record-header"><span>${r.date}</span><span>${r.type.split(' ')[0]}</span></div>
                    <div style="font-size:0.8em;color:#aaa;margin-bottom:8px;">${r.type}</div>
                    <div class="record-content">${contentHtml}</div>
                    <div class="record-actions">
                        <button class="btn btn-secondary btn-sm" onclick="editRecord(${r.id})">Edit</button>
                        <button class="btn btn-secondary btn-sm" style="color:#ef4444;border-color:#ef4444;" onclick="openDeleteModal(${r.id})">Delete</button>
                    </div>
                `;
                list.appendChild(d);
            });
        }
        
        // Image Modal Logic
        function showImgModal(src) {
            document.getElementById('img-modal-target').src = src;
            document.getElementById('img-modal').style.display = 'flex';
        }
        function closeImgModal() {
            document.getElementById('img-modal').style.display = 'none';
        }

        function openDeleteModal(id) {
            recordToDeleteId = id;
            document.getElementById('delete-modal').style.display = 'flex';
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').style.display = 'none';
            recordToDeleteId = null;
        }

        function confirmDeleteAction() {
            if (recordToDeleteId !== null) {
                let records = JSON.parse(localStorage.getItem('cae_logs') || '[]');
                records = records.filter(r => r.id != recordToDeleteId);
                localStorage.setItem('cae_logs', JSON.stringify(records));
                populateYearFilter();
                renderRecords();
                closeDeleteModal();
            }
        }

        function editRecord(id) {
            isEditingMode = true; 
            const records = JSON.parse(localStorage.getItem('cae_logs') || '[]');
            const r = records.find(x => x.id == id);
            if(r) {
                document.getElementById('edit-id').value = r.id;
                document.getElementById('shift-date').value = r.date;
                document.getElementById('shift-type').value = r.type;
                if (r.activities) {
                    currentActivities = r.activities;
                } else if (r.log) {
                    currentActivities = r.log.split('\n\n').filter(x=>x).map(txt => ({ type: "Legacy Entry", desc: txt }));
                } else {
                    currentActivities = [];
                }
                renderActivityList();
                const card = document.querySelector(`.shift-card[data-value="${r.type}"]`);
                if(card) selectShiftCard(card, r.type);
                showPage('shift-page');
            }
        }

        function exportData() {
            const records = localStorage.getItem('cae_logs');
            if (!records || JSON.parse(records).length === 0) {
                showAlert("No records to export.");
                return;
            }
            const blob = new Blob([records], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().split('T')[0];
            a.download = `cae-logs-${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function triggerImport() { document.getElementById('import-file').click(); }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) throw new Error("Invalid format");
                    let currentData = JSON.parse(localStorage.getItem('cae_logs') || '[]');
                    let addedCount = 0;
                    importedData.forEach(item => {
                        if (!currentData.some(existing => existing.id === item.id)) {
                            currentData.push(item);
                            addedCount++;
                        }
                    });
                    currentData.sort((a, b) => b.id - a.id);
                    localStorage.setItem('cae_logs', JSON.stringify(currentData));
                    populateYearFilter();
                    renderRecords();
                    showAlert(`Successfully imported ${addedCount} new records.`);
                } catch (err) {
                    showAlert("Failed to import. Invalid JSON file.");
                    console.error(err);
                }
                input.value = '';
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
